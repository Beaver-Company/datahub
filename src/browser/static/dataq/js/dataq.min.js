!function(){window.DataQ=window.DataQ||{},query=null;var t;DataQ.DQ=function(n,e){t=e;var o=$(DataQ.templates["dataq-container"]());$("body").append(o),query=DataQ.Query(),query.repo(n),$(".dq-black-background").click(function(){$(".dq-black-background").remove(),$(".dataq").remove(),t(null)})};var n=function(){$(".dq-selected-tables").html(""),query.get_selected_tables().forEach(function(t){var n=query.selected_columns(t);if(null!==n){var e=[];n.forEach(function(t){"none"===t.agg?e.push(t.name):e.push(t.agg+"("+t.name+")")});var o=DataQ.templates["dq-selected-table"]({table_name:t,column_list:e.join(", ")});$(".dq-selected-tables").append(o)}}),$(".dq-filter-list").html(""),query.get_filters().forEach(function(t){$(".dq-filter-list").append(DataQ.templates["dq-filter-list-item"]({filter:t}))});var t=[];query.grouping().forEach(function(n){t.push(n.string)}),t.length>0?$(".dq-grouping-text").html(t.join(", ")):$(".dq-grouping-text").html("No Grouping...");var n=[];query.sorts().forEach(function(t){n.push(t.string)}),n.length>0?$(".dq-sorting-text").html(n.join(", ")):$(".dq-sorting-text").html("No Sorting...")};$(document).on("click",".dq-btn-add-table",function(){DataQ.TableModal(query,null,n)}),$(document).on("click",".dq-btn-delete-table",function(){var t=$(this).data("tablename");query.operated_column()&&query.operated_column().split(".")[0]===t&&query.operated_column(null),query.selected_columns(t,null),query.update_grouping(),n()}),$(document).on("click",".dq-btn-edit-table",function(){DataQ.TableModal(query,$(this).data("tablename"),n)}),$(document).on("click",".dq-btn-add-filter",function(){DataQ.FilterModal(query,n)}),$(document).on("click",".dq-btn-delete-filter",function(){var t=$(this).parent().data("code");query.delete_filter(t),n()}),$(document).on("click",".dq-btn-edit-grouping",function(){DataQ.GroupingModal(query,n)}),$(document).on("click",".dq-btn-edit-sorting",function(){DataQ.SortModal(query,n)}),$(document).on("click",".dq-btn-cancel-query",function(){$(".dq-black-background").remove(),$(".dataq").remove(),t(null)}),$(document).on("click",".dq-btn-run-query",function(){$(".dq-black-background").remove(),$(".dataq").remove(),t(DataQ.build_query(query))})}(),function(){window.DataQ=window.DataQ||{},DataQ.API={},DataQ.API.get_repos=function(t){$.get("/apps/dataq/api/",t)},DataQ.API.get_tables=function(t,n){$.get("/apps/dataq/api/"+t+"/",n)},DataQ.API.get_schema=function(t,n,e){$.get("/apps/dataq/api/"+t+"/"+n+"/",e)}}(),function(){window.DataQ=window.DataQ||{};var t,n;DataQ.FilterModal=function(e,o){t=o,n=e;var a=$("#dq-filter-modal");if(0===a.length){var l=[];n.get_selected_tables().forEach(function(t){n.schema(t).forEach(function(n){l.push({column_name:n[0],table_name:t,full_name:t+"."+n[0]})})});var r=DataQ.templates["dq-filter-modal"]({columns:l,repo:n.repo()});$("body").append(r)}$("#dq-filter-modal").modal({keyboard:!1}),$(".modal-backdrop").click(function(){t(),$("#dq-filter-modal").remove()})},$(document).on("click",".dq-filter-quit",function(){t(),$("#dq-filter-modal").remove()}),$(document).on("click",".dq-filter-done",function(){var e=$(".dq-filter-1-text").val(),o=$(".dq-filter-2-text").val(),a=$(".dq-filter-op-text").val();e.length>0&&o.length>0&&a.length>0?(n.add_filter(e,a,o),t(),$("#dq-filter-modal").modal("hide"),$("#dq-filter-modal").remove()):alert("You need to fill out the three text boxes")}),$(document).on("click",".dq-filter-1-link",function(){$(".dq-filter-1-text").val($(this).html())}),$(document).on("click",".dq-filter-2-link",function(){$(".dq-filter-2-text").val($(this).html())}),$(document).on("click",".dq-filter-op-link",function(){var t=$(this).html().replace("&gt;",">").replace("&lt;","<");$(".dq-filter-op-text").val(t)})}(),function(){window.DataQ=window.DataQ||{};var t,n;DataQ.GroupingModal=function(e,o){n=e,t=o;var a=$("#dq-grouping-modal");if(0===a.length){var l=DataQ.templates["dq-grouping-modal"]({columns:n.grouping()});$("body").append(l)}$("#dq-grouping-modal").modal({keyboard:!1}),$("#dq-grouping-modal").on("shown.bs.modal",function(){$(".dq-grouping-modal-list").sortable({forcePlaceholderSize:!0})}),$(".modal-backdrop").click(function(){t(),$("#dq-grouping-modal").remove()})},$(document).on("click","#dq-grouping-modal-quit-btn",function(){t(),$("#dq-grouping-modal").remove()}),$(document).on("click","#dq-grouping-modal-done-btn",function(){var e=[];$(".dq-grouping-list-item").each(function(){var t,o=$(this),a=o.data("string");n.grouping();n.grouping().forEach(function(n){n.string===a&&(t=n)}),e.push(t)}),n.grouping(e),t(),$("#dq-grouping-modal").remove()})}(),function(){window.DataQ=window.DataQ||{};for(var t=["bigint","int8","bigserial","serial8","double precision","float8","integer","int","int4","real","float4","smallint","int2","serial","serial4"],n={},e=0;t>e;e++)n[t[e]]=!0;var o={none:"max",max:"min",min:"sum",sum:"count",count:"avg",avg:"none"},a={none:"count",count:"none"};DataQ.next_aggregate=function(t,e){return null===e&&(e="none"),n[t]?o[e]:a[e]}}(),function(){window.DataQ=window.DataQ||{},window.DataQ.build_query=function(t){var n=[],e=[],o=[],a=[],l=[],r=t.repo();if(t.get_selected_tables().forEach(function(t){e.push(r+"."+t)}),t.get_selected_tables().forEach(function(e){t.selected_columns(e).forEach(function(t){void 0===t.agg||null===t.agg||"none"===t.agg?n.push(r+"."+e+"."+t.name):n.push(t.agg+"("+r+"."+e+"."+t.name+") as "+t.agg+"_"+e+"_"+t.name)})}),t.get_filters().forEach(function(t){o.push(t.filter1+" "+t.op+" "+t.filter2)}),t.grouping().forEach(function(t){var n=t.column.agg;null!==n&&void 0!==n&&"none"!==n||a.push(r+"."+t.string)}),t.sorts().forEach(function(t){var n=t.column.agg;null===n||void 0===n||"none"===n?l.push(r+"."+t.string):l.push(n+"_"+t.table+"_"+t.column.name)}),0===n.length)return"";var d="SELECT "+n.join(", ")+" FROM "+e.join(", ");return o.length>0&&(d+=" WHERE "+o.join(" AND ")),a.length>0&&(d+=" GROUP BY "+a.join(", ")),l.length>0&&(d+=" ORDER BY "+l.join(", ")),d.trim(),d+=";"}}(),function(){window.DataQ=window.DataQ||{},DataQ.Query=function(){var t={};return t._schema_for_table_name={},t._repo_name=null,t._operated_column=null,t._selected_columns_for_table={},t._filter_for_code={},t._grouping=[],t._sorts={},t.schema=function(n,e){return void 0!==e&&(t._schema_for_table_name[n]=e),t._schema_for_table_name[n]},t.repo=function(n){return void 0!==n&&(t._repo_name=n),t._repo_name},t.operated_column=function(n){return void 0!==n&&(t._operated_column=n),t._operated_column},t.update_grouping=function(){t._grouping=[];var n=!1;for(var e in t._selected_columns_for_table)t._selected_columns_for_table[e]&&t._selected_columns_for_table[e].forEach(function(o){"none"===o.agg?t._grouping.push({string:e+"."+o.name,table:e,column:o}):n=!0});n||(t._grouping=[])},t.selected_columns=function(n,e){return void 0!==e&&(t._selected_columns_for_table[n]=e),t._selected_columns_for_table[n]},t.get_selected_tables=function(){var n=[];for(var e in t._selected_columns_for_table)n.push(e);return n},t.add_filter=function(n,e,o){var a=n+" "+e+" "+o,l=md5((new Date).getTime()+a);return t._filter_for_code[l]={filter1:n,op:e,filter2:o,filter_string:a},t._filter_for_code[l]},t.delete_filter=function(n){t._filter_for_code[n]=void 0},t.get_filters=function(){var n=[];for(var e in t._filter_for_code){var o=t._filter_for_code[e];o&&n.push({code:e,filter1:o.filter1,op:o.op,filter2:o.filter2,filter_string:o.filter_string})}return n},t.grouping=function(n){return void 0!==n&&(t._grouping=n),t._grouping},t.add_sort=function(n){t._sorts[n.string]=n},t.delete_sort=function(n){t._sorts[n]=void 0},t.sorts=function(){var n=[];for(var e in t._sorts)void 0!==t._sorts[e]&&n.push(t._sorts[e]);return n},t}}(),function(){window.DataQ=window.DataQ||{};var t,n;DataQ.SortModal=function(e,a){n=e,t=a;var l=$("#dq-sort-modal");if(0===l.length){var r=DataQ.templates["dq-sort-modal"]();$("body").append(r)}$("#dq-sort-modal").modal({keyboard:!1}),$("#dq-sort-modal").on("shown.bs.modal",function(){o()}),$(".modal-backdrop").click(function(){$("#dq-sort-modal").remove(),t()})},$(document).on("click",".dq-sort-modal-dropdown-btn",function(){var t=$(".dq-sort-modal-dropdown");t.html(""),e().forEach(function(n){t.append(DataQ.templates["dq-sort-dropdown-li"]({item:n}))})});var e=function(){var t={};n.sorts().forEach(function(n){t[n.string]=!0});var e=[];return n.get_selected_tables().forEach(function(o){n.selected_columns(o).forEach(function(n){var a=o+"."+n.name;"none"!==n.agg&&(a=n.agg+"("+o+"."+n.name+")"),t[a]||e.push({string:a,table:o,column:n})})}),e},o=function(){var t=$(".dq-sort-item-list");t.html(""),n.sorts().forEach(function(n){var e=DataQ.templates["dq-sort-list-item"]({item:n});t.append(e)})};$(document).on("click",".dq-sort-modal-quit",function(){$("#dq-sort-modal").remove(),t()}),$(document).on("click",".dq-sort-link",function(){var t=$(this),e=t.data("columnname"),a=t.data("columntype"),l=t.data("aggregate"),r=t.data("table"),d=t.data("string");void 0!==l&&null!==l||(l="none");var i={column:{name:e,type:a,agg:l},string:d,table:r};n.add_sort(i),o()}),$(document).on("click",".dq-sort-modal-done-btn",function(){$("#dq-sort-modal").remove(),t()}),$(document).on("click",".dq-sort-delete-btn",function(){var t=$(this).parent().parent(),e=t.data("string");n.delete_sort(e),o()})}(),function(){window.DataQ=window.DataQ||{};var t,n,e;DataQ.TableModal=function(a,l,r){n=l,t=r,e=a;var d=$("#dq-table-modal");if(0===d.length){var i=DataQ.templates["dq-table-modal"]({table_name:n});$("body").append(i)}$("#dq-table-modal").modal({keyboard:!1}),$(".dq-modal-done-btn").hide(),$("#dq-table-modal").on("shown.bs.modal",function(){n&&o(n)}),$(".modal-backdrop").click(function(){$("#dq-table-modal").remove(),t()})},$(document).on("click",".dq-modal-quit",function(){$("#dq-table-modal").remove(),t()}),$(document).on("click",".dq-modal-dropdown-btn",function(){var t=$(".dq-modal-dropdown");t.html(""),DataQ.API.get_tables(e.repo(),function(n){n.tables.forEach(function(n){var e=DataQ.templates["dq-modal-dropdown-item"]({item_name:n});t.append(e)})})}),$(document).on("click",".dq-modal-dropdown-link",function(){var t=$(this).data("item_name");n=t,$(".dq-modal-table-dropdown-text").text(n),o()});var o=function(){DataQ.API.get_schema(e.repo(),n,function(t){$(".dq-modal-done-btn").show(),e.schema(n,t.schema).sort(function(t,n){return t[0]>n[0]});var o=DataQ.templates["dq-modal-columns"]({columns:e.schema(n)});$(".dq-column-list").html(o),e.selected_columns(n)&&e.selected_columns(n).forEach(function(t){var n=$('.dq-modal-column[data-columnname="'+t.name+'"]');n.data("columnname",t.name),n.data("columntype",t.type),n.data("currentaggregate",t.agg||"none"),n.find("input[type=checkbox]").prop("checked",!0),"none"!==t.agg&&n.find("button").text(t.agg+"("+t.name+")")})})};$(document).on("click",".dq-modal-column button",function(){var t=$(this).parent(),o=t.data("columnname"),a=t.data("columntype"),l=t.data("currentaggregate"),r=DataQ.next_aggregate(a,l);e.operated_column()!==n+"."+o&&null!==e.operated_column()&&(r="none"),"none"===r?(e.operated_column()===n+"."+o&&e.operated_column(null),$(this).text(o)):($(this).text(r+"("+o+")"),e.operated_column(n+"."+o)),t.data("currentaggregate",r)}),$(document).on("click",".dq-modal-done-btn",function(){var o=[],a=!1;$(".dq-modal-column").each(function(){var t=$(this);if(t.find("input").is(":checked")){var l=t.data("currentaggregate"),r=t.data("columntype"),d=t.data("columnname");n+"."+d===e.operated_column()&&(a=!0),null!==l&&void 0!==l||(l="none"),o.push({name:d,type:r,agg:l})}}),e.operated_column()&&e.operated_column().split(".")[0]===n&&!a&&e.operated_column(null),e.selected_columns(n,o),e.update_grouping(),$("#dq-table-modal").remove(),t()})}();
//# sourceMappingURL=dataq.min.js.map
