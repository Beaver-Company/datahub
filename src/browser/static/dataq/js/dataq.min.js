!function(){window.DataQ=window.DataQ||{},query=null;var t;DataQ.DQ=function(o,e){t=e;var n=$(DataQ.templates["dataq-container"]());$("body").append(n),query=DataQ.Query(),query.repo(o),$(".dq-black-background").click(function(){$(".dq-black-background").remove(),$(".dataq").remove(),t(null)})};var o=function(){$(".dq-selected-tables").html(""),query.get_selected_tables().forEach(function(t){var o=query.selected_columns(t);if(null!==o){var e=[];o.forEach(function(t){"none"===t.agg?e.push(t.name):e.push(t.agg+"("+t.name+")")});var n=DataQ.templates["dq-selected-table"]({table_name:t,column_list:e.join(", ")});$(".dq-selected-tables").append(n)}}),$(".dq-filter-list").html(""),query.get_filters().forEach(function(t){$(".dq-filter-list").append(DataQ.templates["dq-filter-list-item"]({filter:t}))});var t=[];query.grouping().forEach(function(o){t.push(o.string)}),t.length>0?$(".dq-grouping-text").html(t.join(", ")):$(".dq-grouping-text").html("No Grouping...");var o=[];query.sorts().forEach(function(t){o.push(t.string)}),o.length>0?$(".dq-sorting-text").html(o.join(", ")):$(".dq-sorting-text").html("No Sorting...")};$(document).on("click",".dq-btn-add-table",function(){DataQ.TableModal(query,null,o)}),$(document).on("click",".dq-btn-delete-table",function(){var t=$(this).data("tablename");query.operated_column()&&query.operated_column().split(".")[0]===t&&query.operated_column(null),query.selected_columns(t,null),query.update_grouping(),o()}),$(document).on("click",".dq-btn-edit-table",function(){DataQ.TableModal(query,$(this).data("tablename"),o)}),$(document).on("click",".dq-btn-add-filter",function(){DataQ.FilterModal(query,o)}),$(document).on("click",".dq-btn-delete-filter",function(){var t=$(this).parent().data("code");query.delete_filter(t),o()}),$(document).on("click",".dq-btn-edit-grouping",function(){DataQ.GroupingModal(query,o)}),$(document).on("click",".dq-btn-edit-sorting",function(){DataQ.SortModal(query,o)}),$(document).on("click",".dq-btn-cancel-query",function(){$(".dq-black-background").remove(),$(".dataq").remove(),t(null)}),$(document).on("click",".dq-btn-run-query",function(){$(".dq-black-background").remove(),$(".dataq").remove(),t(DataQ.build_query(query))})}(),function(){window.DataQ=window.DataQ||{},DataQ.API={},DataQ.API.get_repos=function(t){$.get("/apps/dataq/api/",t)},DataQ.API.get_tables=function(t,o){$.get("/apps/dataq/api/"+t+"/",o)},DataQ.API.get_schema=function(t,o,e){$.get("/apps/dataq/api/"+t+"/"+o+"/",e)}}(),function(){window.DataQ=window.DataQ||{};var t,o;DataQ.FilterModal=function(e,n){t=n,o=e;var a=$("#dq-filter-modal");if(0===a.length){var r=[];o.get_selected_tables().forEach(function(t){o.schema(t).forEach(function(o){r.push({column_name:o[0],table_name:t,full_name:t+"."+o[0]})})});var l=DataQ.templates["dq-filter-modal"]({columns:r,repo:o.repo()});$("body").append(l)}$("#dq-filter-modal").modal({keyboard:!1}),$(".modal-backdrop").click(function(){t(),$("#dq-filter-modal").remove()})},$(document).on("click",".dq-filter-quit",function(){t(),$("#dq-filter-modal").remove(),$(".modal-backdrop").remove()}),$(document).on("click",".dq-filter-done",function(){var e=$(".dq-filter-1-text").val(),n=$(".dq-filter-2-text").val(),a=$(".dq-filter-op-text").val();e.length>0&&n.length>0&&a.length>0?(o.add_filter(e,a,n),t(),$("#dq-filter-modal").modal("hide"),$("#dq-filter-modal").remove(),$(".modal-backdrop").remove()):alert("You need to fill out the three text boxes")}),$(document).on("click",".dq-filter-1-link",function(){$(".dq-filter-1-text").val($(this).html())}),$(document).on("click",".dq-filter-2-link",function(){$(".dq-filter-2-text").val($(this).html())}),$(document).on("click",".dq-filter-op-link",function(){var t=$(this).html().replace("&gt;",">").replace("&lt;","<");$(".dq-filter-op-text").val(t)})}(),function(){window.DataQ=window.DataQ||{};var t,o;DataQ.GroupingModal=function(e,n){o=e,t=n;var a=$("#dq-grouping-modal");if(0===a.length){var r=DataQ.templates["dq-grouping-modal"]({columns:o.grouping()});$("body").append(r)}$("#dq-grouping-modal").modal({keyboard:!1}),$("#dq-grouping-modal").on("shown.bs.modal",function(){$(".dq-grouping-modal-list").sortable({forcePlaceholderSize:!0})}),$(".modal-backdrop").click(function(){t(),$("#dq-grouping-modal").remove(),$(".modal-backdrop").remove()})},$(document).on("click","#dq-grouping-modal-quit-btn",function(){t(),$("#dq-grouping-modal").remove(),$(".modal-backdrop").remove()}),$(document).on("click","#dq-grouping-modal-done-btn",function(){var e=[];$(".dq-grouping-list-item").each(function(){var t,n=$(this),a=n.data("string");o.grouping();o.grouping().forEach(function(o){o.string===a&&(t=o)}),e.push(t)}),o.grouping(e),t(),$("#dq-grouping-modal").remove(),$(".modal-backdrop").remove()})}(),function(){window.DataQ=window.DataQ||{};for(var t=["bigint","int8","bigserial","serial8","double precision","float8","integer","int","int4","real","float4","smallint","int2","serial","serial4"],o={},e=0;e<t;e++)o[t[e]]=!0;var n={none:"max",max:"min",min:"sum",sum:"count",count:"avg",avg:"none"},a={none:"count",count:"none"};DataQ.next_aggregate=function(t,e){return null===e&&(e="none"),o[t]?n[e]:a[e]}}(),function(){window.DataQ=window.DataQ||{},window.DataQ.build_query=function(t){var o=[],e=[],n=[],a=[],r=[],l=t.repo();if(t.get_selected_tables().forEach(function(t){e.push(l+"."+t)}),t.get_selected_tables().forEach(function(e){t.selected_columns(e).forEach(function(t){void 0===t.agg||null===t.agg||"none"===t.agg?o.push(l+"."+e+"."+t.name):o.push(t.agg+"("+l+"."+e+"."+t.name+") as "+t.agg+"_"+e+"_"+t.name)})}),t.get_filters().forEach(function(t){n.push(t.filter1+" "+t.op+" "+t.filter2)}),t.grouping().forEach(function(t){var o=t.column.agg;null!==o&&void 0!==o&&"none"!==o||a.push(l+"."+t.string)}),t.sorts().forEach(function(t){var o=t.column.agg;null===o||void 0===o||"none"===o?r.push(l+"."+t.string):r.push(o+"_"+t.table+"_"+t.column.name)}),0===o.length)return"";var d="SELECT "+o.join(", ")+" FROM "+e.join(", ");return n.length>0&&(d+=" WHERE "+n.join(" AND ")),a.length>0&&(d+=" GROUP BY "+a.join(", ")),r.length>0&&(d+=" ORDER BY "+r.join(", ")),d.trim(),d+=";"}}(),function(){window.DataQ=window.DataQ||{},DataQ.Query=function(){var t={};return t._schema_for_table_name={},t._repo_name=null,t._operated_column=null,t._selected_columns_for_table={},t._filter_for_code={},t._grouping=[],t._sorts={},t.schema=function(o,e){return void 0!==e&&(t._schema_for_table_name[o]=e),t._schema_for_table_name[o]},t.repo=function(o){return void 0!==o&&(t._repo_name=o),t._repo_name},t.operated_column=function(o){return void 0!==o&&(t._operated_column=o),t._operated_column},t.update_grouping=function(){t._grouping=[];var o=!1;for(var e in t._selected_columns_for_table)t._selected_columns_for_table[e]&&t._selected_columns_for_table[e].forEach(function(n){"none"===n.agg?t._grouping.push({string:e+"."+n.name,table:e,column:n}):o=!0});o||(t._grouping=[])},t.selected_columns=function(o,e){return void 0!==e&&(t._selected_columns_for_table[o]=e),t._selected_columns_for_table[o]},t.get_selected_tables=function(){var o=[];for(var e in t._selected_columns_for_table)o.push(e);return o},t.add_filter=function(o,e,n){var a=o+" "+e+" "+n,r=md5((new Date).getTime()+a);return t._filter_for_code[r]={filter1:o,op:e,filter2:n,filter_string:a},t._filter_for_code[r]},t.delete_filter=function(o){t._filter_for_code[o]=void 0},t.get_filters=function(){var o=[];for(var e in t._filter_for_code){var n=t._filter_for_code[e];n&&o.push({code:e,filter1:n.filter1,op:n.op,filter2:n.filter2,filter_string:n.filter_string})}return o},t.grouping=function(o){return void 0!==o&&(t._grouping=o),t._grouping},t.add_sort=function(o){t._sorts[o.string]=o},t.delete_sort=function(o){t._sorts[o]=void 0},t.sorts=function(){var o=[];for(var e in t._sorts)void 0!==t._sorts[e]&&o.push(t._sorts[e]);return o},t}}(),function(){window.DataQ=window.DataQ||{};var t,o;DataQ.SortModal=function(e,a){o=e,t=a;var r=$("#dq-sort-modal");if(0===r.length){var l=DataQ.templates["dq-sort-modal"]();$("body").append(l)}$("#dq-sort-modal").modal({keyboard:!1}),$("#dq-sort-modal").on("shown.bs.modal",function(){n()}),$(".modal-backdrop").click(function(){$("#dq-sort-modal").remove(),$(".modal-backdrop").remove(),t()})},$(document).on("click",".dq-sort-modal-dropdown-btn",function(){var t=$(".dq-sort-modal-dropdown");t.html(""),e().forEach(function(o){t.append(DataQ.templates["dq-sort-dropdown-li"]({item:o}))})});var e=function(){var t={};o.sorts().forEach(function(o){t[o.string]=!0});var e=[];return o.get_selected_tables().forEach(function(n){o.selected_columns(n).forEach(function(o){var a=n+"."+o.name;"none"!==o.agg&&(a=o.agg+"("+n+"."+o.name+")"),t[a]||e.push({string:a,table:n,column:o})})}),e},n=function(){var t=$(".dq-sort-item-list");t.html(""),o.sorts().forEach(function(o){var e=DataQ.templates["dq-sort-list-item"]({item:o});t.append(e)})};$(document).on("click",".dq-sort-modal-quit",function(){$("#dq-sort-modal").remove(),$(".modal-backdrop").remove(),t()}),$(document).on("click",".dq-sort-link",function(){var t=$(this),e=t.data("columnname"),a=t.data("columntype"),r=t.data("aggregate"),l=t.data("table"),d=t.data("string");void 0!==r&&null!==r||(r="none");var i={column:{name:e,type:a,agg:r},string:d,table:l};o.add_sort(i),n()}),$(document).on("click",".dq-sort-modal-done-btn",function(){$("#dq-sort-modal").remove(),$(".modal-backdrop").remove(),t()}),$(document).on("click",".dq-sort-delete-btn",function(){var t=$(this).parent().parent(),e=t.data("string");o.delete_sort(e),n()})}(),function(){window.DataQ=window.DataQ||{};var t,o,e;DataQ.TableModal=function(a,r,l){o=r,t=l,e=a;var d=$("#dq-table-modal");if(0===d.length){var i=DataQ.templates["dq-table-modal"]({table_name:o});$("body").append(i)}$("#dq-table-modal").modal({keyboard:!1}),$(".dq-modal-done-btn").hide(),$("#dq-table-modal").on("shown.bs.modal",function(){o&&n(o)}),$(".modal-backdrop").click(function(){$("#dq-table-modal").remove(),$(".modal-backdrop").remove(),t()})},$(document).on("click",".dq-modal-quit",function(){$("#dq-table-modal").remove(),$(".modal-backdrop").remove(),t()}),$(document).on("click",".dq-modal-dropdown-btn",function(){var t=$(".dq-modal-dropdown");t.html(""),DataQ.API.get_tables(e.repo(),function(o){o.tables.forEach(function(o){var e=DataQ.templates["dq-modal-dropdown-item"]({item_name:o});t.append(e)})})}),$(document).on("click",".dq-modal-dropdown-link",function(){var t=$(this).data("item_name");o=t,$(".dq-modal-table-dropdown-text").text(o),n()});var n=function(){DataQ.API.get_schema(e.repo(),o,function(t){$(".dq-modal-done-btn").show(),e.schema(o,t.schema).sort(function(t,o){return t[0]>o[0]});var n=DataQ.templates["dq-modal-columns"]({columns:e.schema(o)});$(".dq-column-list").html(n),e.selected_columns(o)&&e.selected_columns(o).forEach(function(t){var o=$('.dq-modal-column[data-columnname="'+t.name+'"]');o.data("columnname",t.name),o.data("columntype",t.type),o.data("currentaggregate",t.agg||"none"),o.find("input[type=checkbox]").prop("checked",!0),"none"!==t.agg&&o.find("button").text(t.agg+"("+t.name+")")})})};$(document).on("click",".dq-modal-column button",function(){var t=$(this).parent(),n=t.data("columnname"),a=t.data("columntype"),r=t.data("currentaggregate"),l=DataQ.next_aggregate(a,r);e.operated_column()!==o+"."+n&&null!==e.operated_column()&&(l="none"),"none"===l?(e.operated_column()===o+"."+n&&e.operated_column(null),$(this).text(n)):($(this).text(l+"("+n+")"),e.operated_column(o+"."+n)),t.data("currentaggregate",l)}),$(document).on("click",".dq-modal-done-btn",function(){var n=[],a=!1;$(".dq-modal-column").each(function(){var t=$(this);if(t.find("input").is(":checked")){var r=t.data("currentaggregate"),l=t.data("columntype"),d=t.data("columnname");o+"."+d===e.operated_column()&&(a=!0),null!==r&&void 0!==r||(r="none"),n.push({name:d,type:l,agg:r})}}),e.operated_column()&&e.operated_column().split(".")[0]===o&&!a&&e.operated_column(null),e.selected_columns(o,n),e.update_grouping(),$("#dq-table-modal").remove(),$(".modal-backdrop").remove(),console.log("help me"),console.log("now"),t()})}();
//# sourceMappingURL=dataq.min.js.map
