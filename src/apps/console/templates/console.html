{% extends 'layout.html' %} {% block content %}
<div class='container-fluid'>
    <div id='dh-console-container'>
        <div id='dh-console'>
            <pre class='ascii-art-console'>
 _____        _        _    _       _     
|  __ \      | |      | |  | |     | |    
| |  | | __ _| |_ __ _| |__| |_   _| |__  
| |  | |/ _` | __/ _` |  __  | | | | '_ \ 
| |__| | (_| | || (_| | |  | | |_| | |_) |
|_____/ \__,_|\__\__,_|_|  |_|\__,_|_.__/ 
</pre>
            <br />
            <br />
            <div class='punch'>DataHub is a (GitHub-Like) Data Ecosystem for Individuals, Teams and People.
            </div>
            <br />
        </div>
    </div>
</div>
<script type = 'text/javascript' >

var base_url = 'https://datahub-local.mit.edu';
var client_id = '09E2h1ikVvDQBrja3EWJIEjKM4xkzx2mIiXp3ZE5';
var redirect_uri = 'https://datahub-local.mit.edu/apps/console/';
var kCmdList = [
    'connect &lt;repo-base&gt; \t\t\t  -- connect to a datahub user',
    'mkrepo &lt;repo-name&gt; \t\t\t   -- create a new repository',
    'rm &lt;repo-name [-f]&gt; \t\t\t  -- remove a repository',
    'ls \t\t\t\t\t\t\t   -- list repositories',
    'ls &lt;repo-name&gt; \t\t\t\t   -- list tables/views in a repository',
    'desc &lt;repo-name.table-name [-l]&gt;  -- print schema info of a table [with data type]',
    '&lt;other dml&gt; \t\t\t\t\t  -- execute arbitrary dml on a repo.tablename in your currently connected repo-base (not implemented)'
];
var term;
var connection;

// Convenience function to build DataHub URL strings
// Expects a path starting with a slash. If a params object is present,
// it encodes and appends that as query parameters.
function buildURL(path, params) {
    query = '';
    if (params !== undefined && Object.keys(params).length > 0) {
        query = '?' + $.param(params);
    }
    return base_url + path + query;
}

// Convenience function to convert a query string into an associative
// array.
function paramsFromQuery(query) {
    params = {};
    parts = query.split('&');
    for (var i = parts.length - 1; i >= 0; i--) {
        pieces = parts[i].split('=');
        params[decodeURIComponent(pieces[0])] = decodeURIComponent(
            pieces[1].replace(/\+/g, ' '));
    }
    return params;
}

// Convenience function to copy a value to localStorage if it exists in
// an associate array.
function saveIfSet(assocArray, key) {
    if (assocArray[key]) {
        console.log('Saving ' + key + ': ' + assocArray[key]);
        localStorage.setItem(key, assocArray[key]);
    }
}

function set_console_height() {
    var h = window.innerHeight;
    $('#dh-console').height(h * .8);
    return;
}

function authorize_user() {
    // Pull the access token from the URL hash if it's available.
    // Overwrite whatever's currently in storage.
    if (window.location.hash.length > 1) {
        params = paramsFromQuery(window.location.hash.substring(1));
        if (params['access_token']) {
            keys = ['access_token', 'scope'];
            for (var i = keys.length - 1; i >= 0; i--) {
                console.log('Trying ' + keys[i]);
                saveIfSet(params, keys[i]);
            }
            // Clear the hash after handling the access_token.
            // Just setting window.location.hash = '' leaves a dangling #.
            // history.replaceState('', document.title, window.location.pathname + window.location.search);
        }
        console.log(params);
    }

    // Request authorization button
    if (!localStorage.getItem('access_token')) {
        var params = {
            'response_type': 'token',
            'scope': 'read write',
            'client_id': client_id,
            'redirect_uri': redirect_uri
        };
        var authorization_url = buildURL('/oauth2/authorize/', params);
        window.location.href = authorization_url;
    }

    $.ajaxSetup({
        beforeSend: function(xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' +
                localStorage.getItem('access_token'));
        }
    });
}

function make_repo(args) {
    var repo_name = args[1];

    if (args.length != 2) {
        term.error('HELP: mkrepo &lt;repo-name&gt;');
        return;
    }

    $.ajax({
            url: buildURL('/api/v1/repos/' + connection.repo_base + '/'),
            type: 'POST',
            dataType: 'json',
            data: {
                'repo_name': repo_name
            }
        })
        .fail(function(xhr, status, error) {
            // does not error when duplicating existing repo
            console.log(error);
            term.error('failed: no access or other failure?');
        })
        .done(function(data, status, xhr) {
            term.echo('success');
        });
}

function remove_repo(args) {
    var repo_name = args[1];
    var flag = args[2];
    var force = Boolean(flag);

    if (args.length != 2 && !(args.length == 3 && flag == '-f')) {
        term.error('HELP: rm &lt;repo-name [-f]&gt;');
        return;
    }

    $.ajax({
            url: buildURL('/api/v1/repos/' +
                connection.repo_base + '/' + repo_name + '/'),
            type: 'DELETE'
        })
        .fail(function(xhr, status, error) {
            term.error('failed: repo-name does not exist');
        })
        .done(function(data, status, xhr) {
            term.echo('success');
        });
}

function describe_table(args) {
    var repo_table = args[1].split('.');
    var flag = args[2];
    var detail = Boolean(flag);

    // long (possibly bad) logic
    if (repo_table.length != 2 || (args.length != 2 &&
        !(args.length == 3 && flag == '-l'))) {
        term.error('HELP: desc &lt;repo-name.table-name [-l]&gt;');
        return;
    }

    $.ajax({
            url: buildURL('/api/v1/repos/' + connection.repo_base + '/' +
                repo_table[0] + '/tables/' + repo_table[1] + '/'),
            dataType: 'json',
        })
        .fail(function(xhr, status, error) {
            term.error('failed');
        })
        .done(function(data, status, xhr) {
            term.echo('table_schema');

            if (detail) {
                term.echo('COLUMN_NAME: DATA_TYPE');
                term.echo('----------------------');
                var columns = data.columns;
                for (i = 0; i < columns.length; i++) {
                    var c = columns[i];
                    term.echo(c.column_name + ': ' + c.data_type);
                }
            } else {
                term.echo('COLUMN_NAME');
                term.echo('-----------');
                var columns = data.columns;
                for (i = 0; i < columns.length; i++) {
                    term.echo(columns[i].column_name);
                }
            }

            term.echo('');
            term.echo(columns.length + ' columns returned.');
        });
}

function list_repos() {
    $.ajax({
            url: buildURL('/api/v1/repos/' + connection.repo_base + '/'),
            dataType: 'json',
        })
        .fail(function(xhr, status, error) {
            term.error('failed');
        })
        .done(function(data, status, xhr) {
            term.echo('repo_name');
            term.echo('----------');
            var repos = data.repos;
            // format repos better
            for (i = 0; i < repos.length; i++) {
                term.echo(repos[i].repo_name);
            }
            term.echo('');
            term.echo(repos.length + ' rows returned.');
        });
}

function list_tables(args) {
    var repo_name = args[1];

    if (args.length > 2) {
        term.error('HELP: ls [&lt;repo-name&gt;]');
        return;
    }

    $.ajax({
            url: buildURL('/api/v1/repos/' + connection.repo_base +
                '/' + repo_name + '/'),
            dataType: 'json'
        })
        .fail(function(xhr, status, error) {
            term.error('failed: repo-name does not exist');
        })
        .done(function(data, status, xhr) {
            term.echo('table_name');
            term.echo('----------');
            var tables = data.tables;
            // format tables better
            for (i = 0; i < tables.length; i++) {
                term.echo(tables[i].table_name);
            }
            term.echo('');
            term.echo(tables.length + ' rows returned.');
            term.echo('');

            term.echo('view_name');
            term.echo('----------');
            var views = data.views;
            for (j = 0; j < views.length; j++) {
                term.echo(views[j].view_name);
            }
            term.echo('');
            term.echo(views.length + ' rows returned.');
        });
}

function execute_query(cmd) { // this may not work
    $.ajax({
            url: buildURL('/api/v1/query/' + connection.repo_base + '/'),
            data: {'sql': cmd},
            dataType: 'json'
        })
        .fail(function(xhr, status, error) {
            term.error('failed: try \'help\'');
        })
        .done(function(data, status, xhr) {
            term.echo('Success: executed query.');
        });
}

function help() {
    for (var cmd in kCmdList) {
        term.echo(kCmdList[cmd]);
    }
}

$(document).ready(function($) {
    authorize_user(); // reauthorize when token expires?
    set_console_height();
    var login = '{{login}}';
    connection = {
        'user': login,
        'repo_base': login
    };

    function evaluate(command, terminal) {
        var args = $.trim(command.toLowerCase()).split(/ +/);
        var cmd = args[0];
        term = terminal;

        if (cmd == 'whereami') {
            term.echo(connection.user + '.' + connection.repo_base);
        } else if (cmd == 'connect') {
            connect(args);
        } else if (cmd == 'mkrepo') {
            make_repo(args);
        } else if (cmd == 'rm') {
            remove_repo(args);
        } else if (cmd == 'desc') {
            describe_table(args);
        } else if (cmd == 'ls') {
            if (args.length > 1) {
                list_tables(args);
            } else {
                list_repos();
            }
        } else if (cmd == 'help') {
            help();
        } else {
            execute_query(cmd);
        }
    }


    function connect(args) {
        var username = args[1];

        if (args.length != 2) {
            term.error('HELP: connect &lt;repo-base&gt;');
            return;
        }

        $.ajax({
                url: buildURL('/api/v1/repos/' + username + '/'),
                dataType: 'json'
            })
            .fail(function(xhr, status, error) {
                term.error('failed: no access or repo-base does not exist');
            })
            .done(function(data, status, xhr) {
                // have to authorize with other user maybe
                term.push(function(command, terminal) {
                    try {
                        connection.repo_base = terminal.name();
                        evaluate(command, terminal);
                    } catch (error) {
                        terminal.error(error.message);
                    }
                }, {
                    name: username,
                    prompt: connection.user + '@' + username + '> '
                });
            });
    }


    $('#dh-console').terminal(
        function(command, terminal) {
            try {
                connection.repo_base = terminal.name();
                evaluate(command, terminal);
            } catch (error) {
                terminal.error(error.message);
            }
        }, {
            name: connection.user,
            prompt: connection.user + '@' + connection.repo_base + '> ',
            greetings: 'Welcome to DataHub!\nConnected to: ' + connection.user
        }
    );

});
</script>
{% endblock %}
